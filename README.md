# World — локальная разработка

Этот репозиторий содержит бекенд (Django/DRF) и фронтенд (Next.js) для проекта «Мир Странствий», а также инфраструктуру для разработки на Docker.

---

## Требования

- **Docker** и **Docker Compose**
- **Python 3.12+** (для локального запуска бэкенда и утилит)
- Рекомендуется: **VS Code** с Python-плагином (для запуска и дебага бэка)

> Все команды ниже выполняются **из корня репозитория**.

---

## Переменные окружения (`.env`)

Проект использует `.env` в корне репозитория.

1. Создай файл:

```bash
touch .env
```

2. Либо заполни его по примеру `.env.example`, либо сгенерируй секреты через:

```bash
python3 generate_env.py
```

Скрипт выведет строки вида:

```text
DJANGO_SECRET_KEY=...
SALT_KEY=...
CERT_PASSPHRASE=...
REDIS_PASSWORD=...
POSTGRES_PASSWORD=...
```

Их нужно вставить в `.env` (следи, чтобы не было дублей одноимённых ключей).

Минимально важные вещи в `.env`:
- доступ к PostgreSQL: `POSTGRES_DB`, `POSTGRES_USER`, `POSTGRES_PASSWORD`, `POSTGRES_HOST`, `POSTGRES_PORT`
- доступ к Redis: `REDIS_HOST`, `REDIS_PORT`, `REDIS_PASSWORD`
- домены/хосты: `ALLOWED_HOSTS`, `DOMAIN`
- ключи Django: `DJANGO_SECRET_KEY`, `SALT_KEY`, `CERT_PASSPHRASE`

---

## Один раз: настройка локальных доменов

Для удобства используются домены вида:

- `www.localhost`
- `aws.localhost`
- `console.localhost`

Чтобы они работали, нужно один раз прописать их в `/etc/hosts`:

```bash
./infra/infra/debug/add_hosts.sh
```

Скрипт:
- попросит `sudo` при необходимости,
- добавит нужные записи в `/etc/hosts`,
- больше запускать его не нужно (пока не переустановишь систему).

---

## Запуск и остановка сборки

### Запуск дев-сборки

Основная команда для разработки:

```bash
# backend
./app.py debug

# frontend
./app.py debug --mode full
```

Что делает эта команда (в общем виде):

- поднимает Docker-инфраструктуру:
  - PostgreSQL
  - Redis
  - MinIO
  - TaskIQ-воркеры
  - фронтенд (Next.js dev-сервер)
  - nginx-прокси
- прогоняет необходимые миграции автоматически
- подготавливает окружение для локальной разработки

После успешного старта:

- фронт доступен по домену `http://www.localhost`
- Minio консоль по домену `http://console.localhost`
- dev-сервер фронта также доступен по `http://localhost:3000`
- dev-сервер бэкенда также доступен по `http://localhost:8000`

### Остановка и очистка

Чтобы аккуратно остановить и очистить сборку (контейнеры, временные данные и т.д.):

```bash
./app.py stop --clean
```

Используй это, когда:
- хочешь «чистый» запуск с нуля,
- менял важные вещи в окружении,
- надо просто всё выключить после работы.

---

## Работа с бэкендом (Django/DRF)

Бэкенд лежит в директории:

```text
backend/
```

В Docker-композе сервис `backend` для дев-режима закомментирован — бэкенд удобнее запускать **локально**:

- проще дебажить (VS Code, брейкпоинты),
- нет задержек на пересборку образа при частых изменениях кода.

### 1. Локальное Python-окружение

Один раз:

```bash
cd backend

python3 -m venv .venv
source .venv/bin/activate  # Windows: .venv\Scripts\activate

pip install -r requirements.txt
```

Дальше в каждом новом терминале просто активируй окружение:

```bash
cd backend
source .venv/bin/activate
```

### 2. Миграции

При запуске сборки через `./app.py debug` миграции для бэкенда прогоняются автоматически внутри контейнеров, поэтому в обычном цикле разработки руками их запускать не требуется.

Но если ты запускаешь бэкенд отдельно и хочешь вручную обновить схему БД (например, после изменения моделей), можно выполнить:

```bash
cd backend
source .venv/bin/activate

python manage.py migrate
```

Важно: на момент запуска миграций Docker-инфраструктура (`./app.py debug`) уже должна быть поднята, чтобы PostgreSQL был доступен.

### 3. Запуск бэкенда в дев-режиме

#### Вариант А: через VS Code (рекомендуется для бэкендера)

1. Открой репозиторий в VS Code.
2. Убедись, что выбран Python-интерпретатор из `.venv` внутри `backend/`.
3. В разделе **Run and Debug** выбери конфигурацию для Django (например, `Backend: Django` — см. `.vscode/launch.json`, если он есть).
4. Нажми **Start Debugging**.

Бэкенд поднимется на `http://127.0.0.1:8000` или другом порту — в зависимости от настроек конфигурации.

#### Вариант Б: через консоль

```bash
cd backend
source .venv/bin/activate

python manage.py runserver 0.0.0.0:8000
```

Теперь бэкенд доступен по:

- `http://127.0.0.1:8000/`
- `http://localhost:8000/`

nginx / фронтенд могут ходить к нему либо напрямую по порту, либо через настройки прокси.

---

## Работа с фронтендом (Next.js)

Фронтенд лежит в директории:

```text
frontend/
```

Для разработки используется dev-сервер Next.js, крутящийся внутри Docker-контейнера `frontend` (поднимается командой `./app.py debug --mode full`).

### Как это устроено

- Сервис `frontend` монтирует локальную папку `frontend/` внутрь контейнера.
- При изменении файлов во `frontend/` Next.js автоматически пересобирает страницы (hot reload).
- Dev-сервер по умолчанию слушает порт `3000`.

### Как пользоваться

1. Убедись, что запущена сборка:

   ```bash
   ./app.py debug
   ```

2. Открой в браузере:

   - `http://localhost:3000` — прямой доступ к Next.js dev-серверу;
   - `http://www.localhost`— доступ через nginx c доменным именем

3. Редактируй код во `frontend/` — изменения будут применяться автоматически.

Если очень нужно, фронтенд можно запускать и локально (без Docker) через `bun` или `npm`, но основной сценарий — работа через контейнер, как описано выше.

---

## Типичный рабочий цикл разработчика

1. Обновить код:

   ```bash
   git pull
   ```

2. Убедиться, что `.env` актуален.

3. При необходимости (если ещё не делал) один раз выполнить:

   ```bash
   ./infra/infra/debug/add_hosts.sh
   ```

4. Запустить инфраструктуру и фронт:

   ```bash
   ./app.py debug
   ```

5. Запустить бэкенд локально:
   - **через VS Code Debug**, либо
   - через консоль:

     ```bash
     cd backend
     source .venv/bin/activate
     python manage.py runserver 0.0.0.0:8000
     ```

6. Открыть фронт:
   - `http://www.localhost` или
   - `http://localhost:3000`

7. Работать, писать код, гонять тесты.

8. В конце дня (или когда надо сбросить окружение):

   ```bash
   ./app.py stop --clean
   ```

---

## Документация

```bash

   # Swagger
   http://localhost/api/docs/

   # ReDoc
   http://localhost/api/redoc/

   # OpenAPI-схема
   http://localhost/api/schema/

```
